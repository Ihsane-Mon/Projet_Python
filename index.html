<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechStock Pro - Gestion de Stock</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = 'http://localhost:5000/api';

        function App() {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(null);
            const [userRole, setUserRole] = useState('user');
            const [currentPage, setCurrentPage] = useState('products');
            const [cart, setCart] = useState([]);

            useEffect(() => {
                const savedToken = localStorage.getItem('token');
                const savedUser = localStorage.getItem('user');
                const savedRole = localStorage.getItem('role');
                if (savedToken && savedUser) {
                    setToken(savedToken);
                    setUser(savedUser);
                    setUserRole(savedRole || 'user');
                }
            }, []);

            const handleLogin = (username, token, role) => {
                setUser(username);
                setToken(token);
                setUserRole(role || 'user');
                localStorage.setItem('token', token);
                localStorage.setItem('user', username);
                localStorage.setItem('role', role || 'user');
            };

            const handleLogout = () => {
                setUser(null);
                setToken(null);
                setUserRole('user');
                setCart([]);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('role');
                setCurrentPage('products');
            };

            const addToCart = (product, quantity) => {
                setCart(prevCart => {
                    const existingItemIndex = prevCart.findIndex(item => item.product.id === product.id);
                    if (existingItemIndex !== -1) {
                        const newCart = [...prevCart];
                        newCart[existingItemIndex].quantity += quantity;
                        return newCart;
                    }
                    return [...prevCart, { product, quantity }];
                });
            };

            const removeFromCart = (productId) => {
                setCart(prevCart => prevCart.filter(item => item.product.id !== productId));
            };

            const updateCartQuantity = (productId, quantity) => {
                setCart(prevCart => 
                    prevCart.map(item => 
                        item.product.id === productId 
                            ? { ...item, quantity: Math.max(1, quantity) }
                            : item
                    )
                );
            };

            const clearCart = () => setCart([]);

            return (
                <div className="app-container">
                    {user && (
                        <nav>
                            <div className="logo">TechStock Pro</div>
                            <div className="nav-links">
                                <button className={`nav-link ${currentPage === 'products' ? 'active' : ''}`} onClick={() => setCurrentPage('products')}>
                                    Stock
                                </button>
                                <button className={`nav-link cart-badge ${currentPage === 'cart' ? 'active' : ''}`} onClick={() => setCurrentPage('cart')}>
                                    üõí Panier
                                    {cart.length > 0 && <span className="cart-count">{cart.length}</span>}
                                </button>
                                <button className={`nav-link ${currentPage === 'orders' ? 'active' : ''}`} onClick={() => setCurrentPage('orders')}>
                                    Mes Commandes
                                </button>
                                {userRole === 'admin' && (
                                    <button className={`nav-link ${currentPage === 'admin' ? 'active' : ''}`} onClick={() => setCurrentPage('admin')}>
                                        üëë Admin
                                    </button>
                                )}
                                <div className="user-info">
                                    <div className="user-avatar">{user.charAt(0).toUpperCase()}</div>
                                    <span>{user}</span>
                                    {userRole === 'admin' && <span style={{color: 'var(--pink)', fontSize: '0.8rem'}}>ADMIN</span>}
                                    <button className="btn btn-secondary" onClick={handleLogout}>D√©connexion</button>
                                </div>
                            </div>
                        </nav>
                    )}

                    {!user ? (
                        <AuthPage onLogin={handleLogin} />
                    ) : (
                        <main className="main-content">
                            {currentPage === 'products' && <ProductsPage token={token} onAddToCart={addToCart} cart={cart} />}
                            {currentPage === 'cart' && (
                                <CartPage 
                                    token={token}
                                    cart={cart}
                                    onUpdateQuantity={updateCartQuantity}
                                    onRemoveItem={removeFromCart}
                                    onClearCart={clearCart}
                                    onCheckoutComplete={() => setCurrentPage('orders')}
                                />
                            )}
                            {currentPage === 'orders' && <OrdersPage token={token} />}
                            {currentPage === 'admin' && userRole === 'admin' && <AdminPage token={token} />}
                        </main>
                    )}
                </div>
            );
        }

        function AuthPage({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setLoading(true);

                const endpoint = isLogin ? '/auth/login' : '/auth/register';

                try {
                    const response = await fetch(`${API_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (isLogin) {
                            onLogin(data.username, data.token, data.role || 'user');
                        } else {
                            setSuccess('Compte cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.');
                            setIsLogin(true);
                            setPassword('');
                        }
                    } else {
                        setError(data.erreur || 'Une erreur est survenue');
                    }
                } catch (err) {
                    setError('Impossible de se connecter au serveur. V√©rifiez que l\'API est lanc√©e (python api.py).');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <h1 className="auth-title">{isLogin ? 'Connexion' : 'Inscription'}</h1>
                        {error && <div className="error-message">{error}</div>}
                        {success && <div className="success-message">{success}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Nom d'utilisateur</label>
                                <input type="text" className="form-input" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Votre nom d'utilisateur" required autoFocus />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Mot de passe</label>
                                <input type="password" className="form-input" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Votre mot de passe" required />
                            </div>
                            <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={loading}>
                                {loading ? 'Chargement...' : (isLogin ? 'Se connecter' : 'S\'inscrire')}
                            </button>
                        </form>
                        <div className="auth-switch">
                            {isLogin ? 'Pas encore de compte ?' : 'D√©j√† un compte ?'}{' '}
                            <button onClick={() => { setIsLogin(!isLogin); setError(''); setSuccess(''); }}>
                                {isLogin ? 'S\'inscrire' : 'Se connecter'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function ProductsPage({ token, onAddToCart, cart }) {
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [quantities, setQuantities] = useState({});
            const [error, setError] = useState('');
            const [addSuccess, setAddSuccess] = useState('');

            useEffect(() => { fetchProducts(); }, []);

            const fetchProducts = async () => {
                try {
                    const response = await fetch(`${API_URL}/products?limite=100`);
                    const data = await response.json();
                    setProducts(data.produits || []);
                    const initialQuantities = {};
                    (data.produits || []).forEach(p => { initialQuantities[p.id] = 1; });
                    setQuantities(initialQuantities);
                } catch (err) {
                    setError('Erreur lors du chargement des produits');
                } finally {
                    setLoading(false);
                }
            };

            const updateQuantity = (productId, value) => {
                const product = products.find(p => p.id === productId);
                const newValue = Math.max(1, Math.min(value, product.quantite));
                setQuantities({ ...quantities, [productId]: newValue });
            };

            const handleAddToCart = (product) => {
                const quantity = quantities[product.id];
                onAddToCart(product, quantity);
                setAddSuccess(`${product.nom} ajout√© au panier !`);
                setTimeout(() => setAddSuccess(''), 3000);
                setQuantities({ ...quantities, [product.id]: 1 });
            };

            const getStockClass = (quantity) => {
                if (quantity > 50) return 'stock-high';
                if (quantity > 20) return 'stock-medium';
                return 'stock-low';
            };

            const isInCart = (productId) => cart.some(item => item.product.id === productId);

            if (loading) return <div className="loading">Chargement des produits...</div>;

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">Stock Disponible</h1>
                        <p className="page-subtitle">{products.length} produit{products.length > 1 ? 's' : ''} disponible{products.length > 1 ? 's' : ''}</p>
                    </div>
                    {addSuccess && <div className="success-message">{addSuccess}</div>}
                    {error && <div className="error-message">{error}</div>}
                    {products.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">üì¶</div>
                            <div className="empty-state-text">Aucun produit disponible</div>
                        </div>
                    ) : (
                        <div className="products-grid">
                            {products.map((product) => (
                                <div key={product.id} className="product-card">
                                    <div className="product-header">
                                        <span className="product-id">#{product.id}</span>
                                        {isInCart(product.id) && <span className="in-cart-badge">‚úì Panier</span>}
                                    </div>
                                    <div className="product-icon">üì¶</div>
                                    <h3 className="product-name">{product.nom}</h3>
                                    <p className="product-description">{product.description}</p>
                                    <div className="product-info">
                                        <div className="product-price">{product.prix.toFixed(2)}‚Ç¨</div>
                                        <div className={`product-stock ${getStockClass(product.quantite)}`}>{product.quantite} en stock</div>
                                    </div>
                                    {product.quantite > 0 && (
                                        <>
                                            <div style={{display: 'flex', gap: '0.75rem', alignItems: 'center', marginBottom: '1rem'}}>
                                                <div className="quantity-selector">
                                                    <button className="quantity-btn" onClick={() => updateQuantity(product.id, quantities[product.id] - 1)} disabled={quantities[product.id] <= 1}>-</button>
                                                    <input type="number" className="quantity-input" value={quantities[product.id]} onChange={(e) => updateQuantity(product.id, parseInt(e.target.value) || 1)} min="1" max={product.quantite} />
                                                    <button className="quantity-btn" onClick={() => updateQuantity(product.id, quantities[product.id] + 1)} disabled={quantities[product.id] >= product.quantite}>+</button>
                                                </div>
                                            </div>
                                            <button className="btn btn-primary" style={{width: '100%'}} onClick={() => handleAddToCart(product)}>Ajouter au panier</button>
                                        </>
                                    )}
                                    {product.quantite === 0 && <button className="btn btn-secondary" style={{width: '100%'}} disabled>Rupture de stock</button>}
                                </div>
                            ))}
                        </div>
                    )}
                </>
            );
        }

        function CartPage({ token, cart, onUpdateQuantity, onRemoveItem, onClearCart, onCheckoutComplete }) {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const calculateTotal = () => cart.reduce((total, item) => total + (item.product.prix * item.quantity), 0);
            const getTotalItems = () => cart.reduce((total, item) => total + item.quantity, 0);

            const handleCheckout = async () => {
                if (cart.length === 0) return;
                setLoading(true);
                setError('');
                setSuccess('');

                try {
                    // Pr√©parer les items du panier
                    const items = cart.map(item => ({
                        produit_id: item.product.id,
                        quantite: item.quantity
                    }));

                    // Envoyer UNE SEULE commande avec tous les produits
                    const response = await fetch(`${API_URL}/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ items }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setSuccess(`üéâ Commande #${data.commande.id} cr√©√©e avec succ√®s !`);
                        onClearCart();
                        setTimeout(() => onCheckoutComplete(), 1500);
                    } else {
                        const data = await response.json();
                        setError(data.erreur || 'Erreur lors de la cr√©ation de la commande');
                    }
                } catch (err) {
                    setError('Erreur de connexion au serveur. V√©rifiez que l\'API est lanc√©e.');
                } finally {
                    setLoading(false);
                }
            };

            const updateQuantity = (productId, newQuantity) => {
                const item = cart.find(item => item.product.id === productId);
                const validQuantity = Math.max(1, Math.min(newQuantity, item.product.quantite));
                onUpdateQuantity(productId, validQuantity);
            };

            if (cart.length === 0) {
                return (
                    <>
                        <div className="page-header">
                            <h1 className="page-title">Mon Panier</h1>
                            <p className="page-subtitle">Votre panier est vide</p>
                        </div>
                        <div className="empty-state">
                            <div className="empty-state-icon">üõí</div>
                            <div className="empty-state-text">Ajoutez des produits depuis le stock</div>
                        </div>
                    </>
                );
            }

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">Mon Panier</h1>
                        <p className="page-subtitle">{getTotalItems()} article{getTotalItems() > 1 ? 's' : ''} dans votre panier</p>
                    </div>
                    {success && <div className="success-message">{success}</div>}
                    {error && <div className="error-message">{error}</div>}
                    <div className="cart-layout">
                        <div className="cart-items">
                            {cart.map((item) => (
                                <div key={item.product.id} className="cart-item">
                                    <div className="cart-item-image">üì¶</div>
                                    <div>
                                        <div className="cart-item-name">{item.product.nom}</div>
                                        <div className="cart-item-price">{item.product.prix.toFixed(2)}‚Ç¨ √ó {item.quantity} = {(item.product.prix * item.quantity).toFixed(2)}‚Ç¨</div>
                                    </div>
                                    <div className="quantity-selector">
                                        <button className="quantity-btn" onClick={() => updateQuantity(item.product.id, item.quantity - 1)} disabled={item.quantity <= 1}>-</button>
                                        <input type="number" className="quantity-input" value={item.quantity} onChange={(e) => updateQuantity(item.product.id, parseInt(e.target.value) || 1)} min="1" max={item.product.quantite} />
                                        <button className="quantity-btn" onClick={() => updateQuantity(item.product.id, item.quantity + 1)} disabled={item.quantity >= item.product.quantite}>+</button>
                                    </div>
                                    <button className="btn-remove" onClick={() => onRemoveItem(item.product.id)}>Retirer</button>
                                </div>
                            ))}
                        </div>
                        <div className="cart-summary">
                            <h2 className="cart-summary-title">R√©capitulatif</h2>
                            <div className="cart-summary-row"><span className="cart-summary-label">Articles</span><span className="cart-summary-value">{getTotalItems()}</span></div>
                            <div className="cart-summary-row"><span className="cart-summary-label">Sous-total</span><span className="cart-summary-value">{calculateTotal().toFixed(2)}‚Ç¨</span></div>
                            <div className="cart-summary-row"><span className="cart-summary-label">Livraison</span><span className="cart-summary-value" style={{color: 'var(--green)'}}>Gratuite</span></div>
                            <div className="cart-summary-row" style={{paddingTop: '1rem', borderTop: '1px solid var(--border-color)', marginTop: '0.5rem'}}>
                                <span className="cart-summary-label" style={{fontWeight: 700, color: 'var(--text-primary)'}}>Total</span>
                                <span className="cart-summary-value cart-total">{calculateTotal().toFixed(2)}‚Ç¨</span>
                            </div>
                            <button className="btn-checkout" onClick={handleCheckout} disabled={loading || cart.length === 0}>
                                {loading ? 'Traitement...' : '‚úì Valider la commande'}
                            </button>
                            <button className="btn-clear-cart" onClick={onClearCart} disabled={loading}>Vider le panier</button>
                        </div>
                    </div>
                </>
            );
        }

        function OrdersPage({ token }) {
            const [orders, setOrders] = useState([]);
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');

            useEffect(() => { fetchOrders(); fetchProducts(); }, []);

            const fetchOrders = async () => {
                try {
                    const response = await fetch(`${API_URL}/orders`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    setOrders(data.commandes || []);
                } catch (err) {
                    setError('Erreur lors du chargement des commandes');
                } finally {
                    setLoading(false);
                }
            };

            const fetchProducts = async () => {
                try {
                    const response = await fetch(`${API_URL}/products?limite=100`);
                    const data = await response.json();
                    setProducts(data.produits || []);
                } catch (err) {}
            };

            const getProductName = (productId) => {
                const product = products.find(p => p.id === productId);
                return product ? product.nom : `Produit #${productId}`;
            };

            const getStatusLabel = (status) => {
                switch(status) {
                    case 'en_attente': return 'En attente';
                    case 'validee': return 'Valid√©e';
                    case 'annulee': return 'Annul√©e';
                    default: return status;
                }
            };

            if (loading) return <div className="loading">Chargement des commandes...</div>;

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">Mes Commandes</h1>
                        <p className="page-subtitle">{orders.length} commande{orders.length > 1 ? 's' : ''}</p>
                    </div>
                    {error && <div className="error-message">{error}</div>}
                    {orders.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">üìã</div>
                            <div className="empty-state-text">Aucune commande pour le moment</div>
                        </div>
                    ) : (
                        <div className="orders-grid">
                            {orders.map((order) => (
                                <div key={order.id} className="order-card" style={{display: 'block'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem'}}>
                                        <div className="order-id-badge">#{order.id}</div>
                                        <div className={`order-status status-${order.statut.replace('_', '-')}`}>{getStatusLabel(order.statut)}</div>
                                    </div>
                                    <div style={{marginBottom: '0.5rem'}}>
                                        <div style={{fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.5rem'}}>
                                            {new Date(order.date).toLocaleDateString('fr-FR')} √† {new Date(order.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                                        </div>
                                        {order.lignes && order.lignes.length > 0 && (
                                            <div style={{borderTop: '1px solid var(--border-color)', paddingTop: '0.5rem'}}>
                                                {order.lignes.map((ligne, idx) => (
                                                    <div key={idx} style={{display: 'flex', justifyContent: 'space-between', padding: '0.25rem 0', fontSize: '0.9rem'}}>
                                                        <span>{getProductName(ligne.produit_id)} <span style={{color: 'var(--text-secondary)'}}>x{ligne.quantite}</span></span>
                                                        <span style={{color: 'var(--accent)'}}>{ligne.total.toFixed(2)}‚Ç¨</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div style={{borderTop: '1px solid var(--border-color)', paddingTop: '0.5rem', display: 'flex', justifyContent: 'space-between', fontWeight: 600}}>
                                        <span>Total</span>
                                        <span style={{color: 'var(--accent)', fontSize: '1.1rem'}}>{order.total.toFixed(2)}‚Ç¨</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </>
            );
        }

        function ChartComponent({ title, type, data }) {
            const canvasRef = React.useRef(null);
            const chartRef = React.useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data) return;

                // D√©truire le graphique pr√©c√©dent si existant
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'var(--text-primary)',
                                    font: { family: 'Archivo, sans-serif' }
                                }
                            }
                        },
                        scales: type !== 'doughnut' && type !== 'pie' ? {
                            y: {
                                ticks: { color: 'var(--text-secondary)' },
                                grid: { color: 'var(--border-color)' }
                            },
                            x: {
                                ticks: { color: 'var(--text-secondary)' },
                                grid: { color: 'var(--border-color)' }
                            }
                        } : {}
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data, type]);

            return (
                <div style={{marginTop: '2rem', background: 'var(--bg-card)', border: '1px solid var(--border-color)', borderRadius: '12px', padding: '1.5rem'}}>
                    <h3 style={{marginBottom: '1rem', color: 'var(--text-primary)'}}>{title}</h3>
                    <div style={{position: 'relative', height: '300px'}}>
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        }

        function AdminPage({ token }) {
            const [stats, setStats] = useState(null);
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [activeTab, setActiveTab] = useState('stats');
            const [editingProduct, setEditingProduct] = useState(null);
            const [newProduct, setNewProduct] = useState({ nom: '', description: '', prix: '', quantite: '' });
            const [graphsData, setGraphsData] = useState({ evolution: null, topProduits: null, revenus: null });

            useEffect(() => { fetchData(); }, []);

            const fetchData = async () => {
                try {
                    const [statsRes, productsRes, ordersRes, usersRes, evolutionRes, topRes, revenusRes] = await Promise.all([
                        fetch(`${API_URL}/admin/stats`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/products?limite=100`),
                        fetch(`${API_URL}/admin/orders`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/admin/graphs/evolution-ventes`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/admin/graphs/top-produits`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/admin/graphs/revenus-par-produit`, { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);
                    if (statsRes.ok) setStats(await statsRes.json());
                    if (productsRes.ok) { const d = await productsRes.json(); setProducts(d.produits || []); }
                    if (ordersRes.ok) { const d = await ordersRes.json(); setOrders(d.commandes || []); }
                    if (usersRes.ok) { const d = await usersRes.json(); setUsers(d.utilisateurs || []); }
                    
                    // Charger les donn√©es des graphiques
                    const evoData = evolutionRes.ok ? await evolutionRes.json() : null;
                    const topData = topRes.ok ? await topRes.json() : null;
                    const revData = revenusRes.ok ? await revenusRes.json() : null;
                    setGraphsData({ evolution: evoData, topProduits: topData, revenus: revData });
                } catch (err) {
                    setError('Erreur lors du chargement des donn√©es admin');
                } finally {
                    setLoading(false);
                }
            };

            const handleValidateOrder = async (orderId) => {
                try {
                    await fetch(`${API_URL}/admin/orders/${orderId}/validate`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchData();
                } catch (err) {}
            };

            const handleCancelOrder = async (orderId) => {
                try {
                    await fetch(`${API_URL}/admin/orders/${orderId}/cancel`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchData();
                } catch (err) {}
            };

            const handleDeleteProduct = async (productId) => {
                if (!confirm('Supprimer ce produit ?')) return;
                try {
                    await fetch(`${API_URL}/admin/products/${productId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchData();
                } catch (err) {}
            };

            const handleUpdateProduct = async (productId) => {
                try {
                    await fetch(`${API_URL}/admin/products/${productId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(editingProduct)
                    });
                    setEditingProduct(null);
                    fetchData();
                } catch (err) {}
            };

            const handleCreateProduct = async (e) => {
                e.preventDefault();
                try {
                    await fetch(`${API_URL}/admin/products`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ nom: newProduct.nom, description: newProduct.description, prix: parseFloat(newProduct.prix), quantite: parseInt(newProduct.quantite) })
                    });
                    setNewProduct({ nom: '', description: '', prix: '', quantite: '' });
                    fetchData();
                } catch (err) {}
            };

            const handleDownloadData = async (type) => {
                try {
                    const response = await fetch(`${API_URL}/admin/export/${type}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${type}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                } catch (err) {
                    console.error('Erreur lors du t√©l√©chargement:', err);
                }
            };

            if (loading) return <div className="loading">Chargement du panneau admin...</div>;

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">üëë Administration</h1>
                        <p className="page-subtitle">G√©rez votre boutique</p>
                    </div>
                    {error && <div className="error-message">{error}</div>}
                    <div className="admin-tabs">
                        <button className={`admin-tab ${activeTab === 'stats' ? 'active' : ''}`} onClick={() => setActiveTab('stats')}>üìä Stats</button>
                        <button className={`admin-tab ${activeTab === 'products' ? 'active' : ''}`} onClick={() => setActiveTab('products')}>üì¶ Produits</button>
                        <button className={`admin-tab ${activeTab === 'orders' ? 'active' : ''}`} onClick={() => setActiveTab('orders')}>üõí Commandes</button>
                        <button className={`admin-tab ${activeTab === 'users' ? 'active' : ''}`} onClick={() => setActiveTab('users')}>üë• Utilisateurs</button>
                    </div>

                    {activeTab === 'stats' && stats && (
                        <>
                            <div className="stats-grid">
                                <div className="stat-card"><div className="stat-icon">üì¶</div><div className="stat-value">{stats.produits?.total || 0}</div><div className="stat-label">Produits</div></div>
                                <div className="stat-card"><div className="stat-icon">üìä</div><div className="stat-value">{stats.produits?.stock_total || 0}</div><div className="stat-label">Stock total</div></div>
                                <div className="stat-card"><div className="stat-icon">üí∞</div><div className="stat-value">{stats.produits?.valeur_stock?.toFixed(0) || 0}‚Ç¨</div><div className="stat-label">Valeur stock</div></div>
                                <div className="stat-card"><div className="stat-icon">üõí</div><div className="stat-value">{stats.commandes?.total || 0}</div><div className="stat-label">Commandes</div></div>
                                <div className="stat-card"><div className="stat-icon">‚è≥</div><div className="stat-value">{stats.commandes?.en_attente || 0}</div><div className="stat-label">En attente</div></div>
                                <div className="stat-card"><div className="stat-icon">‚úÖ</div><div className="stat-value">{stats.commandes?.validees || 0}</div><div className="stat-label">Valid√©es</div></div>
                                <div className="stat-card"><div className="stat-icon">üíµ</div><div className="stat-value">{stats.commandes?.ca_total?.toFixed(0) || 0}‚Ç¨</div><div className="stat-label">Chiffre d'affaires</div></div>
                                <div className="stat-card"><div className="stat-icon">üë•</div><div className="stat-value">{stats.utilisateurs?.total || 0}</div><div className="stat-label">Utilisateurs</div></div>
                            </div>

                            {graphsData.evolution && graphsData.evolution.dates && (
                                <ChartComponent 
                                    title="üìà √âvolution des ventes" 
                                    type="line"
                                    data={{
                                        labels: graphsData.evolution.dates,
                                        datasets: [{
                                            label: 'Chiffre d\'affaires (‚Ç¨)',
                                            data: graphsData.evolution.totaux,
                                            borderColor: 'var(--accent)',
                                            backgroundColor: 'rgba(255, 20, 147, 0.1)',
                                            borderWidth: 2,
                                            tension: 0.1,
                                            fill: true
                                        }]
                                    }}
                                />
                            )}

                            {graphsData.topProduits && graphsData.topProduits.noms && (
                                <ChartComponent 
                                    title="üèÜ Top 5 Produits" 
                                    type="bar"
                                    data={{
                                        labels: graphsData.topProduits.noms,
                                        datasets: [{
                                            label: 'Quantit√© vendue',
                                            data: graphsData.topProduits.quantites,
                                            backgroundColor: [
                                                'rgba(255, 20, 147, 0.7)',
                                                'rgba(255, 20, 147, 0.6)',
                                                'rgba(255, 20, 147, 0.5)',
                                                'rgba(255, 20, 147, 0.4)',
                                                'rgba(255, 20, 147, 0.3)'
                                            ],
                                            borderColor: 'var(--accent)',
                                            borderWidth: 1
                                        }]
                                    }}
                                />
                            )}

                            {graphsData.revenus && graphsData.revenus.noms && (
                                <ChartComponent 
                                    title="üí∞ R√©partition du chiffre d'affaires" 
                                    type="doughnut"
                                    data={{
                                        labels: graphsData.revenus.noms,
                                        datasets: [{
                                            data: graphsData.revenus.revenus,
                                            backgroundColor: [
                                                'rgba(255, 20, 147, 0.8)',
                                                'rgba(0, 191, 255, 0.8)',
                                                'rgba(50, 205, 50, 0.8)',
                                                'rgba(255, 165, 0, 0.8)',
                                                'rgba(138, 43, 226, 0.8)'
                                            ],
                                            borderColor: 'var(--bg-card)',
                                            borderWidth: 2
                                        }]
                                    }}
                                />
                            )}

                            <div style={{marginTop: '2rem', background: 'var(--bg-card)', border: '1px solid var(--border-color)', borderRadius: '12px', padding: '1.5rem'}}>
                                <h3 style={{marginBottom: '1rem', color: 'var(--text-primary)'}}>üì• T√©l√©charger les donn√©es</h3>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem'}}>
                                    <button className="btn btn-primary" onClick={() => handleDownloadData('products')}>
                                        üì¶ Produits (CSV)
                                    </button>
                                    <button className="btn btn-primary" onClick={() => handleDownloadData('orders')}>
                                        üõí Commandes (CSV)
                                    </button>
                                    <button className="btn btn-primary" onClick={() => handleDownloadData('users')}>
                                        üë• Utilisateurs (CSV)
                                    </button>
                                </div>
                            </div>
                        </>
                    )}

                    {activeTab === 'products' && (
                        <div>
                            <div style={{background: 'var(--bg-card)', border: '1px solid var(--border-color)', borderRadius: '12px', padding: '1.5rem', marginBottom: '2rem'}}>
                                <h3 style={{marginBottom: '1rem'}}>Ajouter un produit</h3>
                                <form onSubmit={handleCreateProduct} style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '1rem'}}>
                                    <input className="form-input" placeholder="Nom" value={newProduct.nom} onChange={(e) => setNewProduct({...newProduct, nom: e.target.value})} required />
                                    <input className="form-input" placeholder="Description" value={newProduct.description} onChange={(e) => setNewProduct({...newProduct, description: e.target.value})} required />
                                    <input className="form-input" type="number" step="0.01" placeholder="Prix (‚Ç¨)" value={newProduct.prix} onChange={(e) => setNewProduct({...newProduct, prix: e.target.value})} required />
                                    <input className="form-input" type="number" placeholder="Quantit√©" value={newProduct.quantite} onChange={(e) => setNewProduct({...newProduct, quantite: e.target.value})} required />
                                    <button type="submit" className="btn btn-primary">+ Ajouter</button>
                                </form>
                            </div>
                            <div className="products-grid">
                                {products.map((product) => (
                                    <div key={product.id} className="product-card">
                                        {editingProduct && editingProduct.id === product.id ? (
                                            <>
                                                <input className="form-input" value={editingProduct.nom} onChange={(e) => setEditingProduct({...editingProduct, nom: e.target.value})} style={{marginBottom: '0.5rem'}} />
                                                <input className="form-input" value={editingProduct.description} onChange={(e) => setEditingProduct({...editingProduct, description: e.target.value})} style={{marginBottom: '0.5rem'}} />
                                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginBottom: '1rem'}}>
                                                    <input className="form-input" type="number" step="0.01" value={editingProduct.prix} onChange={(e) => setEditingProduct({...editingProduct, prix: parseFloat(e.target.value)})} />
                                                    <input className="form-input" type="number" value={editingProduct.quantite} onChange={(e) => setEditingProduct({...editingProduct, quantite: parseInt(e.target.value)})} />
                                                </div>
                                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                                    <button className="btn btn-primary" style={{flex: 1}} onClick={() => handleUpdateProduct(product.id)}>Sauver</button>
                                                    <button className="btn btn-secondary" style={{flex: 1}} onClick={() => setEditingProduct(null)}>Annuler</button>
                                                </div>
                                            </>
                                        ) : (
                                            <>
                                                <div className="product-header"><span className="product-id">#{product.id}</span></div>
                                                <h3 className="product-name">{product.nom}</h3>
                                                <p className="product-description">{product.description}</p>
                                                <div className="product-info">
                                                    <div className="product-price">{product.prix.toFixed(2)}‚Ç¨</div>
                                                    <div className="product-stock stock-high">{product.quantite} en stock</div>
                                                </div>
                                                <div style={{display: 'flex', gap: '0.5rem', marginTop: '1rem'}}>
                                                    <button className="btn btn-primary" style={{flex: 1}} onClick={() => setEditingProduct(product)}>Modifier</button>
                                                    <button className="btn btn-secondary" style={{flex: 1}} onClick={() => handleDeleteProduct(product.id)}>Supprimer</button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'orders' && (
                        <div className="orders-grid">
                            {orders.map((order) => (
                                <div key={order.id} className="order-card" style={{display: 'block'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem'}}>
                                        <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                                            <div className="order-id-badge">#{order.id}</div>
                                            <span style={{fontSize: '0.85rem', color: 'var(--text-secondary)'}}>@{order.username}</span>
                                        </div>
                                        <div className={`order-status status-${order.statut.replace('_', '-')}`}>
                                            {order.statut === 'en_attente' ? 'En attente' : order.statut === 'validee' ? 'Valid√©e' : 'Annul√©e'}
                                        </div>
                                    </div>
                                    <div style={{marginBottom: '0.5rem'}}>
                                        <div style={{fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.5rem'}}>
                                            {new Date(order.date).toLocaleDateString('fr-FR')} √† {new Date(order.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                                        </div>
                                        {order.lignes && order.lignes.length > 0 && (
                                            <div style={{borderTop: '1px solid var(--border-color)', paddingTop: '0.5rem'}}>
                                                {order.lignes.map((ligne, idx) => {
                                                    const product = products.find(p => p.id === ligne.produit_id);
                                                    return (
                                                        <div key={idx} style={{display: 'flex', justifyContent: 'space-between', padding: '0.25rem 0', fontSize: '0.9rem'}}>
                                                            <span>{product ? product.nom : `Produit #${ligne.produit_id}`} <span style={{color: 'var(--text-secondary)'}}>x{ligne.quantite}</span></span>
                                                            <span style={{color: 'var(--accent)'}}>{ligne.total.toFixed(2)}‚Ç¨</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                    <div style={{borderTop: '1px solid var(--border-color)', paddingTop: '0.5rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <span style={{fontWeight: 600}}>Total: <span style={{color: 'var(--accent)', fontSize: '1.1rem'}}>{order.total.toFixed(2)}‚Ç¨</span></span>
                                        {order.statut === 'en_attente' && (
                                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                                <button className="btn btn-primary" style={{padding: '0.4rem 0.7rem'}} onClick={() => handleValidateOrder(order.id)}>‚úì</button>
                                                <button className="btn btn-secondary" style={{padding: '0.4rem 0.7rem'}} onClick={() => handleCancelOrder(order.id)}>‚úó</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === 'users' && (
                        <div className="orders-grid">
                            {users.map((user) => (
                                <div key={user.id} className="order-card">
                                    <div className="order-id-badge">#{user.id}</div>
                                    <div>
                                        <div className="order-product-name">{user.username}</div>
                                        <div className="order-meta">Inscrit le: {new Date(user.created_at).toLocaleDateString('fr-FR')}</div>
                                    </div>
                                    <div className={`order-status ${user.role === 'admin' ? 'status-validee' : 'status-en-attente'}`}>
                                        {user.role === 'admin' ? 'üëë Admin' : 'üë§ User'}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
