<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechStock Pro - Gestion de Stock</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* ThÃ¨me sombre */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #21262d;
            --bg-card-hover: #30363d;
            
            /* Accents */
            --pink: #f778ba;
            --pink-dark: #db61a2;
            --purple: #a371f7;
            --purple-dark: #8957e5;
            --cyan: #58a6ff;
            --green: #3fb950;
            --orange: #d29922;
            --red: #f85149;
            
            /* Textes */
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            
            /* Bordures */
            --border-color: #30363d;
            --border-hover: #8b949e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--pink), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-link {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-link:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--pink-dark), var(--purple-dark));
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--purple), var(--pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: white;
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Titres */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--pink);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
        }

        /* Boutons */
        .btn {
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--pink-dark), var(--purple-dark));
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--pink);
        }

        /* Formulaires */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Archivo', sans-serif;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--pink);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* MESSAGES CORRIGÃ‰S - BIEN LISIBLES */
        .error-message {
            background: #3d1f23;
            border: 1px solid var(--red);
            color: #ff8b85;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .success-message {
            background: #1f3d2a;
            border: 1px solid var(--green);
            color: #7ee787;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        /* Auth */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
        }

        .auth-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--pink);
            text-align: center;
            margin-bottom: 2rem;
            text-transform: uppercase;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
        }

        .auth-switch button {
            background: none;
            border: none;
            color: var(--pink);
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Produits */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .product-card:hover {
            border-color: var(--pink);
            transform: translateY(-2px);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .product-id {
            background: var(--bg-primary);
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .product-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(167, 113, 247, 0.2), rgba(247, 120, 186, 0.2));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .product-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .product-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--pink);
            font-family: 'JetBrains Mono', monospace;
        }

        .product-stock {
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .stock-high { background: rgba(63, 185, 80, 0.2); color: var(--green); }
        .stock-medium { background: rgba(210, 153, 34, 0.2); color: var(--orange); }
        .stock-low { background: rgba(248, 81, 73, 0.2); color: var(--red); }

        /* QuantitÃ© */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-primary);
            padding: 0.3rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover:not(:disabled) {
            background: var(--pink);
            color: white;
        }

        .quantity-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .quantity-input {
            width: 45px;
            text-align: center;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
        }

        .quantity-input:focus { outline: none; }

        /* Panier badge */
        .cart-badge { position: relative; }

        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--pink);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .in-cart-badge {
            background: var(--green);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        /* Panier layout */
        .cart-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .cart-layout { grid-template-columns: 1fr; }
        }

        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .cart-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 1.25rem;
            align-items: center;
        }

        .cart-item:hover { border-color: var(--pink); }

        .cart-item-image {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(167, 113, 247, 0.2), rgba(247, 120, 186, 0.2));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .cart-item-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .cart-item-price {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .btn-remove {
            background: rgba(248, 81, 73, 0.2);
            color: var(--red);
            border: 1px solid rgba(248, 81, 73, 0.4);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-remove:hover { background: rgba(248, 81, 73, 0.3); }

        /* RÃ©sumÃ© panier */
        .cart-summary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            position: sticky;
            top: 2rem;
        }

        .cart-summary-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .cart-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .cart-summary-label {
            color: var(--text-secondary);
        }

        .cart-summary-value {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .cart-total {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--pink);
        }

        .btn-checkout {
            width: 100%;
            background: linear-gradient(135deg, var(--pink-dark), var(--purple-dark));
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.2s ease;
        }

        .btn-checkout:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-checkout:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-clear-cart {
            width: 100%;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.75rem;
            transition: all 0.2s ease;
        }

        .btn-clear-cart:hover {
            background: var(--bg-primary);
            border-color: var(--pink);
            color: var(--text-primary);
        }

        /* Commandes */
        .orders-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.25rem;
            align-items: center;
        }

        .order-card:hover { border-color: var(--purple); }

        .order-id-badge {
            background: var(--bg-primary);
            color: var(--text-secondary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .order-product-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .order-meta {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .status-en-attente { background: rgba(210, 153, 34, 0.2); color: var(--orange); }
        .status-validee { background: rgba(63, 185, 80, 0.2); color: var(--green); }
        .status-annulee { background: rgba(248, 81, 73, 0.2); color: var(--red); }

        /* Ã‰tats */
        .loading {
            text-align: center;
            padding: 4rem;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Admin */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--purple);
            transform: translateY(-2px);
        }

        .stat-icon { font-size: 1.8rem; margin-bottom: 0.75rem; }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .admin-tab {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.7rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .admin-tab:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .admin-tab.active {
            background: linear-gradient(135deg, var(--pink-dark), var(--purple-dark));
            border-color: transparent;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            .main-content { padding: 1rem; }
            .page-title { font-size: 1.6rem; }
            .cart-item {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .cart-item-image { margin: 0 auto; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = 'http://localhost:5000/api';

        function App() {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(null);
            const [userRole, setUserRole] = useState('user');
            const [currentPage, setCurrentPage] = useState('products');
            const [cart, setCart] = useState([]);

            useEffect(() => {
                const savedToken = localStorage.getItem('token');
                const savedUser = localStorage.getItem('user');
                const savedRole = localStorage.getItem('role');
                if (savedToken && savedUser) {
                    setToken(savedToken);
                    setUser(savedUser);
                    setUserRole(savedRole || 'user');
                }
            }, []);

            const handleLogin = (username, token, role) => {
                setUser(username);
                setToken(token);
                setUserRole(role || 'user');
                localStorage.setItem('token', token);
                localStorage.setItem('user', username);
                localStorage.setItem('role', role || 'user');
            };

            const handleLogout = () => {
                setUser(null);
                setToken(null);
                setUserRole('user');
                setCart([]);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('role');
                setCurrentPage('products');
            };

            const addToCart = (product, quantity) => {
                setCart(prevCart => {
                    const existingItemIndex = prevCart.findIndex(item => item.product.id === product.id);
                    if (existingItemIndex !== -1) {
                        const newCart = [...prevCart];
                        newCart[existingItemIndex].quantity += quantity;
                        return newCart;
                    }
                    return [...prevCart, { product, quantity }];
                });
            };

            const removeFromCart = (productId) => {
                setCart(prevCart => prevCart.filter(item => item.product.id !== productId));
            };

            const updateCartQuantity = (productId, quantity) => {
                setCart(prevCart => 
                    prevCart.map(item => 
                        item.product.id === productId 
                            ? { ...item, quantity: Math.max(1, quantity) }
                            : item
                    )
                );
            };

            const clearCart = () => setCart([]);

            return (
                <div className="app-container">
                    {user && (
                        <nav>
                            <div className="logo">TechStock Pro</div>
                            <div className="nav-links">
                                <button className={`nav-link ${currentPage === 'products' ? 'active' : ''}`} onClick={() => setCurrentPage('products')}>
                                    Stock
                                </button>
                                <button className={`nav-link cart-badge ${currentPage === 'cart' ? 'active' : ''}`} onClick={() => setCurrentPage('cart')}>
                                    ðŸ›’ Panier
                                    {cart.length > 0 && <span className="cart-count">{cart.length}</span>}
                                </button>
                                <button className={`nav-link ${currentPage === 'orders' ? 'active' : ''}`} onClick={() => setCurrentPage('orders')}>
                                    Mes Commandes
                                </button>
                                {userRole === 'admin' && (
                                    <button className={`nav-link ${currentPage === 'admin' ? 'active' : ''}`} onClick={() => setCurrentPage('admin')}>
                                        ðŸ‘‘ Admin
                                    </button>
                                )}
                                <div className="user-info">
                                    <div className="user-avatar">{user.charAt(0).toUpperCase()}</div>
                                    <span>{user}</span>
                                    {userRole === 'admin' && <span style={{color: 'var(--pink)', fontSize: '0.8rem'}}>ADMIN</span>}
                                    <button className="btn btn-secondary" onClick={handleLogout}>DÃ©connexion</button>
                                </div>
                            </div>
                        </nav>
                    )}

                    {!user ? (
                        <AuthPage onLogin={handleLogin} />
                    ) : (
                        <main className="main-content">
                            {currentPage === 'products' && <ProductsPage token={token} onAddToCart={addToCart} cart={cart} />}
                            {currentPage === 'cart' && (
                                <CartPage 
                                    token={token}
                                    cart={cart}
                                    onUpdateQuantity={updateCartQuantity}
                                    onRemoveItem={removeFromCart}
                                    onClearCart={clearCart}
                                    onCheckoutComplete={() => setCurrentPage('orders')}
                                />
                            )}
                            {currentPage === 'orders' && <OrdersPage token={token} />}
                            {currentPage === 'admin' && userRole === 'admin' && <AdminPage token={token} />}
                        </main>
                    )}
                </div>
            );
        }

        function AuthPage({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setLoading(true);

                const endpoint = isLogin ? '/auth/login' : '/auth/register';

                try {
                    const response = await fetch(`${API_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (isLogin) {
                            onLogin(data.username, data.token, data.role || 'user');
                        } else {
                            setSuccess('Compte crÃ©Ã© avec succÃ¨s ! Vous pouvez maintenant vous connecter.');
                            setIsLogin(true);
                            setPassword('');
                        }
                    } else {
                        setError(data.erreur || 'Une erreur est survenue');
                    }
                } catch (err) {
                    setError('Impossible de se connecter au serveur. VÃ©rifiez que l\'API est lancÃ©e (python api.py).');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <h1 className="auth-title">{isLogin ? 'Connexion' : 'Inscription'}</h1>
                        {error && <div className="error-message">{error}</div>}
                        {success && <div className="success-message">{success}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Nom d'utilisateur</label>
                                <input type="text" className="form-input" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Votre nom d'utilisateur" required autoFocus />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Mot de passe</label>
                                <input type="password" className="form-input" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Votre mot de passe" required />
                            </div>
                            <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={loading}>
                                {loading ? 'Chargement...' : (isLogin ? 'Se connecter' : 'S\'inscrire')}
                            </button>
                        </form>
                        <div className="auth-switch">
                            {isLogin ? 'Pas encore de compte ?' : 'DÃ©jÃ  un compte ?'}{' '}
                            <button onClick={() => { setIsLogin(!isLogin); setError(''); setSuccess(''); }}>
                                {isLogin ? 'S\'inscrire' : 'Se connecter'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function ProductsPage({ token, onAddToCart, cart }) {
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [quantities, setQuantities] = useState({});
            const [error, setError] = useState('');
            const [addSuccess, setAddSuccess] = useState('');

            useEffect(() => { fetchProducts(); }, []);

            const fetchProducts = async () => {
                try {
                    const response = await fetch(`${API_URL}/products?limite=100`);
                    const data = await response.json();
                    setProducts(data.produits || []);
                    const initialQuantities = {};
                    (data.produits || []).forEach(p => { initialQuantities[p.id] = 1; });
                    setQuantities(initialQuantities);
                } catch (err) {
                    setError('Erreur lors du chargement des produits');
                } finally {
                    setLoading(false);
                }
            };

            const updateQuantity = (productId, value) => {
                const product = products.find(p => p.id === productId);
                const newValue = Math.max(1, Math.min(value, product.quantite));
                setQuantities({ ...quantities, [productId]: newValue });
            };

            const handleAddToCart = (product) => {
                const quantity = quantities[product.id];
                onAddToCart(product, quantity);
                setAddSuccess(`${product.nom} ajoutÃ© au panier !`);
                setTimeout(() => setAddSuccess(''), 3000);
                setQuantities({ ...quantities, [product.id]: 1 });
            };

            const getStockClass = (quantity) => {
                if (quantity > 50) return 'stock-high';
                if (quantity > 20) return 'stock-medium';
                return 'stock-low';
            };

            const isInCart = (productId) => cart.some(item => item.product.id === productId);

            if (loading) return <div className="loading">Chargement des produits...</div>;

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">Stock Disponible</h1>
                        <p className="page-subtitle">{products.length} produit{products.length > 1 ? 's' : ''} disponible{products.length > 1 ? 's' : ''}</p>
                    </div>
                    {addSuccess && <div className="success-message">{addSuccess}</div>}
                    {error && <div className="error-message">{error}</div>}
                    {products.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">ðŸ“¦</div>
                            <div className="empty-state-text">Aucun produit disponible</div>
                        </div>
                    ) : (
                        <div className="products-grid">
                            {products.map((product) => (
                                <div key={product.id} className="product-card">
                                    <div className="product-header">
                                        <span className="product-id">#{product.id}</span>
                                        {isInCart(product.id) && <span className="in-cart-badge">âœ“ Panier</span>}
                                    </div>
                                    <div className="product-icon">ðŸ“¦</div>
                                    <h3 className="product-name">{product.nom}</h3>
                                    <p className="product-description">{product.description}</p>
                                    <div className="product-info">
                                        <div className="product-price">{product.prix.toFixed(2)}â‚¬</div>
                                        <div className={`product-stock ${getStockClass(product.quantite)}`}>{product.quantite} en stock</div>
                                    </div>
                                    {product.quantite > 0 && (
                                        <>
                                            <div style={{display: 'flex', gap: '0.75rem', alignItems: 'center', marginBottom: '1rem'}}>
                                                <div className="quantity-selector">
                                                    <button className="quantity-btn" onClick={() => updateQuantity(product.id, quantities[product.id] - 1)} disabled={quantities[product.id] <= 1}>-</button>
                                                    <input type="number" className="quantity-input" value={quantities[product.id]} onChange={(e) => updateQuantity(product.id, parseInt(e.target.value) || 1)} min="1" max={product.quantite} />
                                                    <button className="quantity-btn" onClick={() => updateQuantity(product.id, quantities[product.id] + 1)} disabled={quantities[product.id] >= product.quantite}>+</button>
                                                </div>
                                            </div>
                                            <button className="btn btn-primary" style={{width: '100%'}} onClick={() => handleAddToCart(product)}>Ajouter au panier</button>
                                        </>
                                    )}
                                    {product.quantite === 0 && <button className="btn btn-secondary" style={{width: '100%'}} disabled>Rupture de stock</button>}
                                </div>
                            ))}
                        </div>
                    )}
                </>
            );
        }

        function CartPage({ token, cart, onUpdateQuantity, onRemoveItem, onClearCart, onCheckoutComplete }) {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const calculateTotal = () => cart.reduce((total, item) => total + (item.product.prix * item.quantity), 0);
            const getTotalItems = () => cart.reduce((total, item) => total + item.quantity, 0);

            const handleCheckout = async () => {
                if (cart.length === 0) return;
                setLoading(true);
                setError('');
                setSuccess('');

                try {
                    const promises = cart.map(item => 
                        fetch(`${API_URL}/orders`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ produit_id: item.product.id, quantite: item.quantity }),
                        })
                    );

                    const responses = await Promise.all(promises);
                    const allSuccess = responses.every(r => r.ok);

                    if (allSuccess) {
                        setSuccess('ðŸŽ‰ Commandes crÃ©Ã©es avec succÃ¨s !');
                        onClearCart();
                        setTimeout(() => onCheckoutComplete(), 1500);
                    } else {
                        const errors = await Promise.all(responses.map(async (r, i) => {
                            if (!r.ok) {
                                const data = await r.json();
                                return `${cart[i].product.nom}: ${data.erreur}`;
                            }
                            return null;
                        }));
                        setError(`Erreurs: ${errors.filter(e => e).join(', ')}`);
                    }
                } catch (err) {
                    setError('Erreur de connexion au serveur. VÃ©rifiez que l\'API est lancÃ©e.');
                } finally {
                    setLoading(false);
                }
            };

            const updateQuantity = (productId, newQuantity) => {
                const item = cart.find(item => item.product.id === productId);
                const validQuantity = Math.max(1, Math.min(newQuantity, item.product.quantite));
                onUpdateQuantity(productId, validQuantity);
            };

            if (cart.length === 0) {
                return (
                    <>
                        <div className="page-header">
                            <h1 className="page-title">Mon Panier</h1>
                            <p className="page-subtitle">Votre panier est vide</p>
                        </div>
                        <div className="empty-state">
                            <div className="empty-state-icon">ðŸ›’</div>
                            <div className="empty-state-text">Ajoutez des produits depuis le stock</div>
                        </div>
                    </>
                );
            }

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">Mon Panier</h1>
                        <p className="page-subtitle">{getTotalItems()} article{getTotalItems() > 1 ? 's' : ''} dans votre panier</p>
                    </div>
                    {success && <div className="success-message">{success}</div>}
                    {error && <div className="error-message">{error}</div>}
                    <div className="cart-layout">
                        <div className="cart-items">
                            {cart.map((item) => (
                                <div key={item.product.id} className="cart-item">
                                    <div className="cart-item-image">ðŸ“¦</div>
                                    <div>
                                        <div className="cart-item-name">{item.product.nom}</div>
                                        <div className="cart-item-price">{item.product.prix.toFixed(2)}â‚¬ Ã— {item.quantity} = {(item.product.prix * item.quantity).toFixed(2)}â‚¬</div>
                                    </div>
                                    <div className="quantity-selector">
                                        <button className="quantity-btn" onClick={() => updateQuantity(item.product.id, item.quantity - 1)} disabled={item.quantity <= 1}>-</button>
                                        <input type="number" className="quantity-input" value={item.quantity} onChange={(e) => updateQuantity(item.product.id, parseInt(e.target.value) || 1)} min="1" max={item.product.quantite} />
                                        <button className="quantity-btn" onClick={() => updateQuantity(item.product.id, item.quantity + 1)} disabled={item.quantity >= item.product.quantite}>+</button>
                                    </div>
                                    <button className="btn-remove" onClick={() => onRemoveItem(item.product.id)}>Retirer</button>
                                </div>
                            ))}
                        </div>
                        <div className="cart-summary">
                            <h2 className="cart-summary-title">RÃ©capitulatif</h2>
                            <div className="cart-summary-row"><span className="cart-summary-label">Articles</span><span className="cart-summary-value">{getTotalItems()}</span></div>
                            <div className="cart-summary-row"><span className="cart-summary-label">Sous-total</span><span className="cart-summary-value">{calculateTotal().toFixed(2)}â‚¬</span></div>
                            <div className="cart-summary-row"><span className="cart-summary-label">Livraison</span><span className="cart-summary-value" style={{color: 'var(--green)'}}>Gratuite</span></div>
                            <div className="cart-summary-row" style={{paddingTop: '1rem', borderTop: '1px solid var(--border-color)', marginTop: '0.5rem'}}>
                                <span className="cart-summary-label" style={{fontWeight: 700, color: 'var(--text-primary)'}}>Total</span>
                                <span className="cart-summary-value cart-total">{calculateTotal().toFixed(2)}â‚¬</span>
                            </div>
                            <button className="btn-checkout" onClick={handleCheckout} disabled={loading || cart.length === 0}>
                                {loading ? 'Traitement...' : 'âœ“ Valider la commande'}
                            </button>
                            <button className="btn-clear-cart" onClick={onClearCart} disabled={loading}>Vider le panier</button>
                        </div>
                    </div>
                </>
            );
        }

        function OrdersPage({ token }) {
            const [orders, setOrders] = useState([]);
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');

            useEffect(() => { fetchOrders(); fetchProducts(); }, []);

            const fetchOrders = async () => {
                try {
                    const response = await fetch(`${API_URL}/orders`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    setOrders(data.commandes || []);
                } catch (err) {
                    setError('Erreur lors du chargement des commandes');
                } finally {
                    setLoading(false);
                }
            };

            const fetchProducts = async () => {
                try {
                    const response = await fetch(`${API_URL}/products?limite=100`);
                    const data = await response.json();
                    setProducts(data.produits || []);
                } catch (err) {}
            };

            const getProductName = (productId) => {
                const product = products.find(p => p.id === productId);
                return product ? product.nom : `Produit #${productId}`;
            };

            const getStatusLabel = (status) => {
                switch(status) {
                    case 'en_attente': return 'En attente';
                    case 'validee': return 'ValidÃ©e';
                    case 'annulee': return 'AnnulÃ©e';
                    default: return status;
                }
            };

            if (loading) return <div className="loading">Chargement des commandes...</div>;

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">Mes Commandes</h1>
                        <p className="page-subtitle">{orders.length} commande{orders.length > 1 ? 's' : ''}</p>
                    </div>
                    {error && <div className="error-message">{error}</div>}
                    {orders.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">ðŸ“‹</div>
                            <div className="empty-state-text">Aucune commande pour le moment</div>
                        </div>
                    ) : (
                        <div className="orders-grid">
                            {orders.map((order) => (
                                <div key={order.id} className="order-card">
                                    <div className="order-id-badge">#{order.id}</div>
                                    <div>
                                        <div className="order-product-name">{getProductName(order.produit_id)}</div>
                                        <div className="order-meta">QtÃ©: {order.quantite} â€¢ Total: {order.total.toFixed(2)}â‚¬ â€¢ {new Date(order.date).toLocaleDateString('fr-FR')}</div>
                                    </div>
                                    <div className={`order-status status-${order.statut.replace('_', '-')}`}>{getStatusLabel(order.statut)}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </>
            );
        }

        function AdminPage({ token }) {
            const [stats, setStats] = useState(null);
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [activeTab, setActiveTab] = useState('stats');
            const [editingProduct, setEditingProduct] = useState(null);
            const [newProduct, setNewProduct] = useState({ nom: '', description: '', prix: '', quantite: '' });

            useEffect(() => { fetchData(); }, []);

            const fetchData = async () => {
                try {
                    const [statsRes, productsRes, ordersRes, usersRes] = await Promise.all([
                        fetch(`${API_URL}/admin/stats`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/products?limite=100`),
                        fetch(`${API_URL}/admin/orders`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);
                    if (statsRes.ok) setStats(await statsRes.json());
                    if (productsRes.ok) { const d = await productsRes.json(); setProducts(d.produits || []); }
                    if (ordersRes.ok) { const d = await ordersRes.json(); setOrders(d.commandes || []); }
                    if (usersRes.ok) { const d = await usersRes.json(); setUsers(d.utilisateurs || []); }
                } catch (err) {
                    setError('Erreur lors du chargement des donnÃ©es admin');
                } finally {
                    setLoading(false);
                }
            };

            const handleValidateOrder = async (orderId) => {
                try {
                    await fetch(`${API_URL}/admin/orders/${orderId}/validate`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchData();
                } catch (err) {}
            };

            const handleCancelOrder = async (orderId) => {
                try {
                    await fetch(`${API_URL}/admin/orders/${orderId}/cancel`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchData();
                } catch (err) {}
            };

            const handleDeleteProduct = async (productId) => {
                if (!confirm('Supprimer ce produit ?')) return;
                try {
                    await fetch(`${API_URL}/admin/products/${productId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchData();
                } catch (err) {}
            };

            const handleUpdateProduct = async (productId) => {
                try {
                    await fetch(`${API_URL}/admin/products/${productId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(editingProduct)
                    });
                    setEditingProduct(null);
                    fetchData();
                } catch (err) {}
            };

            const handleCreateProduct = async (e) => {
                e.preventDefault();
                try {
                    await fetch(`${API_URL}/admin/products`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ nom: newProduct.nom, description: newProduct.description, prix: parseFloat(newProduct.prix), quantite: parseInt(newProduct.quantite) })
                    });
                    setNewProduct({ nom: '', description: '', prix: '', quantite: '' });
                    fetchData();
                } catch (err) {}
            };

            if (loading) return <div className="loading">Chargement du panneau admin...</div>;

            return (
                <>
                    <div className="page-header">
                        <h1 className="page-title">ðŸ‘‘ Administration</h1>
                        <p className="page-subtitle">GÃ©rez votre boutique</p>
                    </div>
                    {error && <div className="error-message">{error}</div>}
                    <div className="admin-tabs">
                        <button className={`admin-tab ${activeTab === 'stats' ? 'active' : ''}`} onClick={() => setActiveTab('stats')}>ðŸ“Š Stats</button>
                        <button className={`admin-tab ${activeTab === 'products' ? 'active' : ''}`} onClick={() => setActiveTab('products')}>ðŸ“¦ Produits</button>
                        <button className={`admin-tab ${activeTab === 'orders' ? 'active' : ''}`} onClick={() => setActiveTab('orders')}>ðŸ›’ Commandes</button>
                        <button className={`admin-tab ${activeTab === 'users' ? 'active' : ''}`} onClick={() => setActiveTab('users')}>ðŸ‘¥ Utilisateurs</button>
                    </div>

                    {activeTab === 'stats' && stats && (
                        <div className="stats-grid">
                            <div className="stat-card"><div className="stat-icon">ðŸ“¦</div><div className="stat-value">{stats.produits?.total || 0}</div><div className="stat-label">Produits</div></div>
                            <div className="stat-card"><div className="stat-icon">ðŸ“Š</div><div className="stat-value">{stats.produits?.stock_total || 0}</div><div className="stat-label">Stock total</div></div>
                            <div className="stat-card"><div className="stat-icon">ðŸ’°</div><div className="stat-value">{stats.produits?.valeur_stock?.toFixed(0) || 0}â‚¬</div><div className="stat-label">Valeur stock</div></div>
                            <div className="stat-card"><div className="stat-icon">ðŸ›’</div><div className="stat-value">{stats.commandes?.total || 0}</div><div className="stat-label">Commandes</div></div>
                            <div className="stat-card"><div className="stat-icon">â³</div><div className="stat-value">{stats.commandes?.en_attente || 0}</div><div className="stat-label">En attente</div></div>
                            <div className="stat-card"><div className="stat-icon">âœ…</div><div className="stat-value">{stats.commandes?.validees || 0}</div><div className="stat-label">ValidÃ©es</div></div>
                            <div className="stat-card"><div className="stat-icon">ðŸ’µ</div><div className="stat-value">{stats.commandes?.ca_total?.toFixed(0) || 0}â‚¬</div><div className="stat-label">Chiffre d'affaires</div></div>
                            <div className="stat-card"><div className="stat-icon">ðŸ‘¥</div><div className="stat-value">{stats.utilisateurs?.total || 0}</div><div className="stat-label">Utilisateurs</div></div>
                        </div>
                    )}

                    {activeTab === 'products' && (
                        <div>
                            <div style={{background: 'var(--bg-card)', border: '1px solid var(--border-color)', borderRadius: '12px', padding: '1.5rem', marginBottom: '2rem'}}>
                                <h3 style={{marginBottom: '1rem'}}>Ajouter un produit</h3>
                                <form onSubmit={handleCreateProduct} style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '1rem'}}>
                                    <input className="form-input" placeholder="Nom" value={newProduct.nom} onChange={(e) => setNewProduct({...newProduct, nom: e.target.value})} required />
                                    <input className="form-input" placeholder="Description" value={newProduct.description} onChange={(e) => setNewProduct({...newProduct, description: e.target.value})} required />
                                    <input className="form-input" type="number" step="0.01" placeholder="Prix (â‚¬)" value={newProduct.prix} onChange={(e) => setNewProduct({...newProduct, prix: e.target.value})} required />
                                    <input className="form-input" type="number" placeholder="QuantitÃ©" value={newProduct.quantite} onChange={(e) => setNewProduct({...newProduct, quantite: e.target.value})} required />
                                    <button type="submit" className="btn btn-primary">+ Ajouter</button>
                                </form>
                            </div>
                            <div className="products-grid">
                                {products.map((product) => (
                                    <div key={product.id} className="product-card">
                                        {editingProduct && editingProduct.id === product.id ? (
                                            <>
                                                <input className="form-input" value={editingProduct.nom} onChange={(e) => setEditingProduct({...editingProduct, nom: e.target.value})} style={{marginBottom: '0.5rem'}} />
                                                <input className="form-input" value={editingProduct.description} onChange={(e) => setEditingProduct({...editingProduct, description: e.target.value})} style={{marginBottom: '0.5rem'}} />
                                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginBottom: '1rem'}}>
                                                    <input className="form-input" type="number" step="0.01" value={editingProduct.prix} onChange={(e) => setEditingProduct({...editingProduct, prix: parseFloat(e.target.value)})} />
                                                    <input className="form-input" type="number" value={editingProduct.quantite} onChange={(e) => setEditingProduct({...editingProduct, quantite: parseInt(e.target.value)})} />
                                                </div>
                                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                                    <button className="btn btn-primary" style={{flex: 1}} onClick={() => handleUpdateProduct(product.id)}>Sauver</button>
                                                    <button className="btn btn-secondary" style={{flex: 1}} onClick={() => setEditingProduct(null)}>Annuler</button>
                                                </div>
                                            </>
                                        ) : (
                                            <>
                                                <div className="product-header"><span className="product-id">#{product.id}</span></div>
                                                <h3 className="product-name">{product.nom}</h3>
                                                <p className="product-description">{product.description}</p>
                                                <div className="product-info">
                                                    <div className="product-price">{product.prix.toFixed(2)}â‚¬</div>
                                                    <div className="product-stock stock-high">{product.quantite} en stock</div>
                                                </div>
                                                <div style={{display: 'flex', gap: '0.5rem', marginTop: '1rem'}}>
                                                    <button className="btn btn-primary" style={{flex: 1}} onClick={() => setEditingProduct(product)}>Modifier</button>
                                                    <button className="btn btn-secondary" style={{flex: 1}} onClick={() => handleDeleteProduct(product.id)}>Supprimer</button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'orders' && (
                        <div className="orders-grid">
                            {orders.map((order) => {
                                const product = products.find(p => p.id === order.produit_id);
                                return (
                                    <div key={order.id} className="order-card" style={{gridTemplateColumns: 'auto 1fr auto auto'}}>
                                        <div className="order-id-badge">#{order.id}</div>
                                        <div>
                                            <div className="order-product-name">{product ? product.nom : `Produit #${order.produit_id}`}</div>
                                            <div className="order-meta">QtÃ©: {order.quantite} â€¢ Total: {order.total.toFixed(2)}â‚¬ â€¢ {new Date(order.date).toLocaleDateString('fr-FR')}</div>
                                        </div>
                                        <div className={`order-status status-${order.statut.replace('_', '-')}`}>
                                            {order.statut === 'en_attente' ? 'En attente' : order.statut === 'validee' ? 'ValidÃ©e' : 'AnnulÃ©e'}
                                        </div>
                                        {order.statut === 'en_attente' && (
                                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                                <button className="btn btn-primary" style={{padding: '0.4rem 0.7rem'}} onClick={() => handleValidateOrder(order.id)}>âœ“</button>
                                                <button className="btn btn-secondary" style={{padding: '0.4rem 0.7rem'}} onClick={() => handleCancelOrder(order.id)}>âœ—</button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {activeTab === 'users' && (
                        <div className="orders-grid">
                            {users.map((user) => (
                                <div key={user.id} className="order-card">
                                    <div className="order-id-badge">#{user.id}</div>
                                    <div>
                                        <div className="order-product-name">{user.username}</div>
                                        <div className="order-meta">Inscrit le: {new Date(user.created_at).toLocaleDateString('fr-FR')}</div>
                                    </div>
                                    <div className={`order-status ${user.role === 'admin' ? 'status-validee' : 'status-en-attente'}`}>
                                        {user.role === 'admin' ? 'ðŸ‘‘ Admin' : 'ðŸ‘¤ User'}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
